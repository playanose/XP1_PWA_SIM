<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>X-PRO1 ANALOG</title>
    <style>
        :root { --fuji-red: #cc0000; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; font-family: monospace; overflow: hidden; color: #eee; }

        /* Viewfinder */
        .viewport { position: relative; width: 100vw; height: 75vh; overflow: hidden; background: #000; }
        #preview { width: 100%; height: 100%; object-fit: contain; }
        
        /* Live Grain Overlay */
        .grain-overlay {
            position: absolute; inset: 0; pointer-events: none;
            filter: url(#grain-filter); mix-blend-mode: overlay; opacity: 0.15;
        }

        /* Simulation Filters */
        .sim-std   { filter: saturate(1.0) contrast(1.1); }
        .sim-vivid { filter: saturate(1.8) contrast(1.2); }
        .sim-soft  { filter: saturate(0.7) contrast(0.9); }
        .sim-mono  { filter: grayscale(100%) contrast(1.3); }
        .sim-sepia { filter: sepia(0.8) contrast(1.0); }

        /* UI Panel */
        .ui-panel { height: 25vh; background: #111; display: flex; flex-direction: column; border-top: 1px solid #333; }
        .dial { display: flex; overflow-x: auto; padding: 10px; gap: 10px; }
        .mode-btn { padding: 8px 15px; border: 1px solid #444; background: #000; font-size: 10px; color: #888; white-space: nowrap; }
        .mode-btn.active { background: var(--fuji-red); color: #fff; }
        .shutter-row { flex-grow: 1; display: flex; justify-content: space-around; align-items: center; }
        .shutter-btn { width: 65px; height: 65px; background: #fff; border-radius: 50%; border: 4px solid #333; }
        .status-text { font-size: 9px; text-transform: uppercase; color: #666; text-align: center; }
    </style>
</head>
<body>

<div class="viewport">
    <video id="preview" class="sim-std" autoplay playsinline></video>
    <div class="grain-overlay"></div>
    <div id="leak-preview" style="position:absolute; inset:0; pointer-events:none;"></div>
</div>

<div class="ui-panel">
    <div class="dial">
        <div class="mode-btn active" data-sim="std">PROVIA</div>
        <div class="mode-btn" data-sim="vivid">VELVIA</div>
        <div class="mode-btn" data-sim="soft">ASTIA</div>
        <div class="mode-btn" data-sim="mono">MONO</div>
        <div class="mode-btn" data-sim="sepia">SEPIA</div>
    </div>
    <div class="shutter-row">
        <div class="status-text">GRAIN<br><span id="grain-val">--</span></div>
        <button class="shutter-btn" id="shutter"></button>
        <div class="status-text">LEAK<br><span id="leak-status">OFF</span></div>
    </div>
</div>

<canvas id="buffer" style="display:none;"></canvas>

<svg style="display:none;">
    <filter id="grain-filter">
        <feTurbulence type="fractalNoise" baseFrequency="0.7" numOctaves="3" stitchTiles="stitch" />
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.2 0" />
    </filter>
</svg>

<script>
    const video = document.getElementById('preview');
    const canvas = document.getElementById('buffer');
    const shutter = document.getElementById('shutter');
    const grainLabel = document.getElementById('grain-val');
    const leakLabel = document.getElementById('leak-status');

    async function init() {
        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode:'environment', width:{ideal:4000} } });
        video.srcObject = s;
    }

    // 1. Generate Light Leak
    function applyLightLeak(ctx, w, h) {
        if (Math.random() > 0.4) { // 60% chance of a leak
            leakLabel.innerText = "ACTIVE";
            const x = Math.random() * w;
            const y = Math.random() * h;
            const radius = Math.random() * w + (w/2);
            const grad = ctx.createRadialGradient(x, y, 0, x, y, radius);
            
            const colors = ['rgba(255,80,0,0.4)', 'rgba(255,0,0,0.3)', 'rgba(255,150,50,0.2)', 'transparent'];
            grad.addColorStop(0, colors[Math.floor(Math.random()*3)]);
            grad.addColorStop(1, 'transparent');
            
            ctx.globalCompositeOperation = 'screen';
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, w, h);
            ctx.globalCompositeOperation = 'source-over';
        } else {
            leakLabel.innerText = "NONE";
        }
    }

    // 2. Capture Logic
    shutter.onclick = () => {
        const ctx = canvas.getContext('2d');
        const w = video.videoWidth;
        const h = video.videoHeight;
        canvas.width = w; canvas.height = h;

        // Apply Simulation
        ctx.filter = getComputedStyle(video).filter;
        ctx.drawImage(video, 0, 0, w, h);

        // Apply Random Grain (5% to 25%)
        const grainIntensity = (Math.random() * (0.25 - 0.05) + 0.05).toFixed(2);
        grainLabel.innerText = Math.round(grainIntensity * 100) + "%";
        
        ctx.globalCompositeOperation = 'overlay';
        ctx.filter = `url(#grain-filter) opacity(${grainIntensity})`;
        ctx.fillRect(0, 0, w, h);
        ctx.globalCompositeOperation = 'source-over';

        // Apply Light Leak
        applyLightLeak(ctx, w, h);

        // Download
        const link = document.createElement('a');
        link.download = `XPRO1_ANALOG_${Date.now()}.jpg`;
        link.href = canvas.toDataURL('image/jpeg', 0.9);
        link.click();
    };

    // Mode Selector
    document.querySelectorAll('.mode-btn').forEach(b => {
        b.onclick = () => {
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            b.classList.add('active');
            video.className = 'sim-' + b.dataset.sim;
        };
    });

    init();
</script>
</body>
</html>
